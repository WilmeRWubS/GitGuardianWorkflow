name: Cleanup Secrets (Manual Trigger)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "yes" to confirm history rewrite (DANGER!)'
        required: true
        default: "no"
      dry_run:
        description: 'Dry run mode (true/false): just show findings without cleanup'
        required: true
        default: "true"
      secrets_to_replace:
        description: |
          Geef 1 of meerdere √©chte secrets op, gescheiden met een komma.
          Voorbeeld: abc123,ghp_exampletoken456,32cb10apikey...
        required: false
      auto_push:
        description: 'Automatically push cleaned history (true/false) - DANGER!'
        required: true
        default: "false"
      delete_all_runs:
        description: 'Also attempt to delete all workflow runs (true/false)'
        required: false
        default: "false"

jobs:
  scan-and-clean:
    runs-on: ubuntu-latest
    name: Scan for secrets en eventueel herschrijf geschiedenis

    steps:
      - name: Checkout volledige repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Installeer ggshield en git-filter-repo
        run: |
          pip install --upgrade ggshield
          sudo apt-get update && sudo apt-get install -y git-filter-repo gh jq

      - name: Draai ggshield scan (verbose)
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
        run: |
          echo "üîç Start scan met ggshield (verbose)..."
          ggshield secret scan repo . --verbose | tee scan_output.txt

      - name: Toon ggshield scan output
        run: |
          echo "üóå Bekijk de scan-output hierboven."
          echo "Zoek regels met *** of duidelijke tokens."
          echo "Voer de √©chte geheimen handmatig in als secrets_to_replace (gescheiden door komma's)."

      - name: Herschrijf commits correct met behoud van geschiedenis
        if: ${{ github.event.inputs.confirm == 'yes' && github.event.inputs.dry_run != 'true' && github.event.inputs.secrets_to_replace != '' }}
        run: |
          echo "üîß Herschrijven met behoud van commitgeschiedenis..."

          mkdir cleaned_repo
          git clone --mirror $GITHUB_WORKSPACE cleaned_repo/repo.git
          cd cleaned_repo/repo.git

          IFS=',' read -ra secrets <<< "${{ github.event.inputs.secrets_to_replace }}"
          for secret in "${secrets[@]}"; do
            trimmed=$(echo "$secret" | xargs)
            if [[ "$trimmed" == '***' || "$trimmed" == 'REDACTED' || -z "$trimmed" ]]; then
              echo "‚ö†Ô∏è Ongeldige waarde '$trimmed' wordt overgeslagen."
              continue
            fi
            echo "üîÅ Replacing '$trimmed' with 'REDACTED'"
            git-filter-repo --force --replace-text <(echo "$trimmed==REDACTED")
          done

          if [[ "${{ github.event.inputs.auto_push }}" == "true" ]]; then
            echo "üöÄ Pushing herschreven repo naar origin..."
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            git push --mirror --force
            echo "‚úÖ Gepushte herschreven geschiedenis met behoud van commits!"
          fi

      - name: (Optioneel) Verwijder alle workflow runs via API
        if: ${{ github.event.inputs.delete_all_runs == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üö© Start verwijdering van alle workflow runs..."

          REPO=${{ github.repository }}
          gh api --paginate "/repos/$REPO/actions/runs" \
            | jq -r '.workflow_runs[].id' \
            | while read -r run_id; do
                echo "üîç Verwijderen run ID: $run_id"
                gh api -X DELETE "/repos/$REPO/actions/runs/$run_id" && echo "‚úÖ Run $run_id verwijderd" || echo "‚ùå Mislukt: $run_id"
              done

      - name: Geen actie uitgevoerd
        if: ${{ github.event.inputs.confirm != 'yes' || github.event.inputs.dry_run == 'true' || github.event.inputs.secrets_to_replace == '' }}
        run: |
          echo "‚ÑπÔ∏è Geen herschrijving uitgevoerd. Controleer of je:"
          echo "- 'confirm' op 'yes' hebt gezet"
          echo "- 'dry_run' op 'false' hebt gezet"
          echo "- minstens 1 geldige secret hebt opgegeven (gescheiden met komma's)"
          echo "- 'auto_push' op 'true' hebt gezet (optioneel voor automatisch pushen)"