name: Cleanup Secrets (Manual Trigger)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "yes" to confirm history rewrite (DANGER!)'
        required: true
        default: "no"
      dry_run:
        description: 'Dry run mode (true/false): just show findings without cleanup'
        required: true
        default: "true"
      secrets_to_replace:
        description: |
          Geef 1 of meerdere √©chte secrets op, gescheiden met een komma.
          Voorbeeld: abc123,ghp_exampletoken456,32cb10apikey...
        required: false

jobs:
  scan-and-clean:
    runs-on: ubuntu-latest
    name: Scan for secrets en eventueel herschrijf geschiedenis

    steps:
      - name: Checkout volledige repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Installeer ggshield en git-filter-repo
        run: |
          pip install --upgrade ggshield
          sudo apt-get update && sudo apt-get install -y git-filter-repo

      - name: Draai ggshield scan (verbose)
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
        run: |
          echo "üîç Start scan met ggshield (verbose, gemaskeerd)..."
          ggshield secret scan repo . --verbose | tee scan_output.txt

      - name: Toon ggshield scan output
        run: |
          echo "üìã Bekijk de scan-output hierboven."
          echo "Zoek regels met *** en bepaal het volledige geheim in je code."
          echo "Voer de echte waarde(n) hieronder in, gescheiden door een komma."

      - name: Condioneel herschrijven met git-filter-repo
        if: ${{ github.event.inputs.confirm == 'yes' && github.event.inputs.dry_run != 'true' && github.event.inputs.secrets_to_replace != '' }}
        run: |
          echo "üö® Start herschrijven van Git-geschiedenis..."

          mkdir filtered_repo && cd filtered_repo
          git clone --bare $GITHUB_WORKSPACE repo.git
          cd repo.git

          # Split de input op komma's en loop eroverheen
          IFS=',' read -ra secrets <<< "${{ github.event.inputs.secrets_to_replace }}"
          for secret in "${secrets[@]}"; do
            trimmed=$(echo "$secret" | xargs)  # trim spaties
            if [ -n "$trimmed" ]; then
              echo "üîí Vervang '$trimmed' met 'REDACTED'"
              git-filter-repo --force --replace-text <(echo "$trimmed==REDACTED")
            fi
          done

          echo "‚úÖ Cleanup voltooid. Je kunt handmatig pushen met:"
          echo "   cd filtered_repo/repo.git && git push --mirror --force"

      - name: Geen actie uitgevoerd
        if: ${{ github.event.inputs.confirm != 'yes' || github.event.inputs.dry_run == 'true' || github.event.inputs.secrets_to_replace == '' }}
        run: |
          echo "‚ÑπÔ∏è Geen herschrijving uitgevoerd. Controleer of je:"
          echo "- 'confirm' op 'yes' hebt gezet"
          echo "- 'dry_run' op 'false' hebt gezet"
          echo "- minstens 1 secret hebt opgegeven in 'secrets_to_replace' (gescheiden door komma's)"
